Start-Transcript -Path "$env:temp\CVE-2022-41040_LogScan.log"
try {
# Try to pull the log directory from the web administration module
Import-Module WebAdministration -ErrorAction "Stop"
$Sites = Get-Website -ErrorAction "Stop"
$logdirectories = $sites | foreach-object {$_.logfile.directory -replace '%SystemDrive%',"$env:SystemDrive"} -ErrorAction "Stop"
}
Catch {
    # If unable to pull log directory, try the default path
    $error[0].message
    Write-Output "`nTrying default log directory path C:\inetpub\logs\LogFiles"
    if (test-path 'C:\inetpub\logs\LogFiles'){
    $logdirectories = 'C:\inetpub\logs\LogFiles'
    }
    else {
    "Unable to locate log directory"
     Stop-Transcript
     break
         } 
}
Write-Output "Found log directories $($logdirectories)"
$logs = $logdirectories | foreach-object {Get-ChildItem -Path $_ -recurse | Where-Object {$_.extension -like '*.log'} | Sort-Object -Property LastWriteTime | Select-Object -Last 10} # Get the most recent 10 logs
# loop through each log one at a time
foreach ($log in $logs){
    Write-Output "Checking $($log.fullname)"
    $content = Get-Content -Path $log.fullname
    $logmatch = $content | Select-String -Pattern 'powershell.*autodiscover\.json.*\@.*200'
    if ($logmatch.count -gt 0){
    Write-Output "MATCHES FOUND:"
    $logmatch
    }
    else {"No matches found"}
    # Remove $content variable and run garbage collection
    # this is an extra safeguard against memory leaks
    remove-variable content 
    [GC]::Collect()
}
Stop-Transcript
